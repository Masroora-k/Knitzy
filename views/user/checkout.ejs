<%-include("../../views/partials/user/user-header")%>

  <link rel="stylesheet" href="/stylesheets/checkout.css">



  <div class="container  mt-4">
    <div class="row">
      <div class=" mt-3 col-lg-6 col-md-12 col-sm-12 mb-4">
        <div class="checkout">
          <h6 class="mb-4" style="color: rgb(150, 148, 147);">Checkout</h6>
          <!-- Shipping Address Form -->
          <div class=" p-2 ">
            <h4 class="mb-3">Shipping Address</h4>
            <div class="list-group address-sec mt-3 ">
              <%if(userAddress){%>
                <%userAddress.address.forEach((address)=>{%>
                  <div class="list-group-item d-flex   addressList" style="flex-direction: column;">
                    <div>
                      <address>

                        <b>Name: </b>
                        <%=address.name%> <br>
                          <b>Address: </b>
                          <%=address.address%> <br>
                            <b>City:</b>
                            <%=address.city%> <br>
                              <b>Landmark:</b>
                              <%=address.landMark%> <br>
                                <b>State:</b>
                                <%=address.state%> <br>
                                  <b>Pincode:</b>
                                  <%=address.pincode%> <br>
                                    <b>Phone:</b>
                                    <%=address.phone%> <br>
                                      <b>Alternate Phone:</b>
                                      <%=address.altPhone%>
                      </address>
                    </div>

                    <div class="d-flex justify-content-end">
                      <button type="submit" class="btn confirm me-2 mb-2" data-address-id="<%=address._id%>" >Deliver to This Address</button>
                      <a href="/editAddressCheckout?id=<%=address._id%>"
                        class="btn btn-outline-warning btn-sm me-2 mb-2">Edit</a>
                      <a href="/deleteAddressCheckout?id=<%=address._id%>" class="btn btn-outline-danger btn-sm mb-2"
                        onclick="return confirm('Are you sure you want to delete this address')">Delete</a>
                    </div>
                  </div>
                  <%})%>
                    <%}else{%>
                      <div class="list-group-item d-flex justify-content-between align-items-center">
                        No Address
                      </div>
                      <%}%>
            </div>
            <div class="d-flex flex-column flex-md-row justify-content-between mt-4">
              <a href="/addAddressCheckout" class="btn btn-outline-primary mt-3 mb-3 w-100">Add New Address</a>

            </div>

          </div>
        </div>
      </div>


      <div class=" mt-4 col-lg-6 col-md-12 col-sm-12">

        <!-- Order Summary -->
        <div class="checkout">
          <h4 class="mb-3">Order Summary</h4>
          <div class="order-summary mb-3">

            <%cart.forEach(item=>{%>
              <div class="d-flex mb-3"
                style="border: 1px solid rgb(226, 222, 222); padding: 10px; border-radius: 10px;">
                <img src="<%=item.productId.productImage[0]%>" alt="Product Image" class="product-image">
                <div class="ms-3">
                  <h6>
                    <%= item.productId.productName%>
                  </h6>
                  <p>Price: <i class="fa-solid fa-indian-rupee-sign"></i><span
                      style="font-size: 1rem; font-weight: bold;">
                      <%= item.productId.salePrice%>
                    </span></p>
                  <p>Quantity: <span style="font-size: 1rem; font-weight: bold;">
                      <%= item.quantity%>
                    </span></p>
                    <p>Total Price: <span style="font-size: 1rem; font-weight: bold;">
                      <%= item.totalPrice%>
                    </span></p>
                </div>
              </div>
              <%})%>
          </div>

          <p><b>Total Amount:</b> <span><i class="fa-solid fa-indian-rupee-sign"></i>
              <%=totalAmount%>
            </span></p>
          <button class="btn btn-primary btn-lg btn-block  " id="proceed-to-payment" type="button">Proceed to Payment</button>
        </div>

      </div>
    </div>
  </div>


  <%-include("../../views/partials/user/user-footer")%>


  <script>
    let selectedAddressId = null;
  
    document.querySelectorAll('.btn.confirm').forEach(button => {
  button.addEventListener('click', function() {
    selectedAddressId = this.getAttribute('data-address-id');
    console.log("Selected Address ID: ", selectedAddressId); // Add this line to debug
    // Highlight selected address
    document.querySelectorAll('.list-group-item').forEach(item => item.classList.remove('selected-address'));
    this.closest('.list-group-item').classList.add('selected-address');
  });
});



    document.getElementById('proceed-to-payment').addEventListener('click', function() {
  if (!selectedAddressId) {
    Swal.fire({
      icon: 'warning',
      title: 'No Address Selected',
      text: 'Please select a shipping address before proceeding to payment.',
    });
  } else {
    // Send GET request with addressId
    fetch(`/passAddress?addressId=${selectedAddressId}`, {
      method: 'GET', // GET request method
      headers: {
        'Content-Type': 'application/json',
      },
    })
    .then(response => response.json())  // Assuming the server sends a JSON response
    .then(data => {
      if (data.success) {
        // Redirect to the payment page or handle success
        window.location.href = '/payment';
      } else {
        // Show error if something went wrong
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: data.message || 'Something went wrong.',
        });
      }
    })
    .catch(error => {
      console.error('Error:', error);
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'There was an issue with the payment request.',
      });
    });
  }
});



  </script>
  
  <style>
    .selected-address {
      border: 2px solid #007bff;
    }
  </style>